name: Test Playwright Scraper

on:
  workflow_dispatch:

jobs:
  test-playwright:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright beautifulsoup4
          playwright install chromium
          playwright install-deps
      
      - name: Run Playwright scraper
        run: |
          python playwright_scraper_gemini.py
      
      - name: Display results
        if: always()
        run: |
          echo "=== TEST RESULTS ==="
          if [ -f playwright_test_results.json ]; then
            cat playwright_test_results.json
          else
            echo "No results file generated"
          fi
      
      - name: Upload debug HTML files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-html-files
          path: debug_*.html
          if-no-files-found: warn
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: playwright_test_results.json
          if-no-files-found: warn
      
      - name: Check success
        if: always()
        run: |
          if [ -f playwright_test_results.json ]; then
            SUCCESS=$(cat playwright_test_results.json | grep -o '"successful": [0-9]*' | grep -o '[0-9]*')
            echo "Certificates successfully scraped: $SUCCESS"
            
            # Check if we extracted actual real data
            HAS_ISSUER=$(grep -c '"issuer":[[:space:]]*"[^N"][^"]*"' playwright_test_results.json 2>/dev/null || echo "0")
            HAS_COUPON=$(grep -c '"coupon":' playwright_test_results.json 2>/dev/null || echo "0")
            HAS_BARRIER=$(grep -c '"barrier":' playwright_test_results.json 2>/dev/null || echo "0")
            HAS_PRICE=$(grep -c '"price":' playwright_test_results.json 2>/dev/null || echo "0")
            
            echo "Certificates with issuer (non-N/A): $HAS_ISSUER"
            echo "Certificates with coupon: $HAS_COUPON"
            echo "Certificates with barrier: $HAS_BARRIER"
            echo "Certificates with price: $HAS_PRICE"
            echo ""
            
            # Calculate completeness score safely
            if [ "$SUCCESS" -gt 0 ]; then
              TOTAL_FIELDS=$((HAS_ISSUER + HAS_COUPON + HAS_BARRIER + HAS_PRICE))
              MAX_FIELDS=$((SUCCESS * 4))
              if [ "$MAX_FIELDS" -gt 0 ]; then
                COMPLETENESS=$((TOTAL_FIELDS * 100 / MAX_FIELDS))
              else
                COMPLETENESS=0
              fi
            else
              COMPLETENESS=0
            fi
            
            echo ""
            echo "Data completeness: $COMPLETENESS%"
            echo ""
            
            if [ "$HAS_COUPON" -gt 0 ] && [ "$HAS_PRICE" -gt 0 ]; then
              if [ "$HAS_ISSUER" -gt 0 ] && [ "$HAS_BARRIER" -gt 0 ]; then
                echo "‚úÖ‚úÖ‚úÖ PERFECT! All data extracted! ‚úÖ‚úÖ‚úÖ"
                echo "- Issuer: YES"
                echo "- Coupon: YES"
                echo "- Barrier: YES"
                echo "- Price: YES"
              else
                echo "‚úÖ‚úÖ GOOD! Core data extracted! ‚úÖ‚úÖ"
                echo "- Coupon: YES"
                echo "- Price: YES"
                if [ "$HAS_ISSUER" -eq 0 ]; then
                  echo "- Issuer: MISSING (needs fix)"
                fi
                if [ "$HAS_BARRIER" -eq 0 ]; then
                  echo "- Barrier: MISSING (needs fix)"
                fi
              fi
              echo ""
              echo "üéâ Ready for production with completeness: $COMPLETENESS%"
              exit 0
            elif [ "$SUCCESS" -gt 0 ]; then
              echo ""
              echo "‚ö†Ô∏è  Partial success - connected but some data missing"
              echo "Check debug HTML files to improve parsing"
              exit 0
            else
              echo "‚ùå No certificates extracted"
              exit 1
            fi
          else
            echo "‚ùå No results file - script failed to run"
            exit 1
          fi

# Copyright (c) 2024-2025 Mutna S.R.L.S. - All Rights Reserved
# P.IVA: 04219740364
#
# CED Lab Pro - Daily Certificates Update
# Runs at 22:00 Italian time (21:00 UTC in winter, 20:00 UTC in summer)

name: CED Lab Pro - Daily Update

on:
  # Schedule: 21:00 UTC = 22:00 Italy (winter) / 23:00 Italy (summer)
  schedule:
    - cron: '0 21 * * *'
  
  # Manual trigger
  workflow_dispatch:

jobs:
  scrape-certificates:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install playwright beautifulsoup4
          playwright install chromium
          playwright install-deps chromium
      
      - name: ğŸ” Verify credentials
        run: |
          if [ -z "${{ secrets.CED_USERNAME }}" ] || [ -z "${{ secrets.CED_PASSWORD }}" ]; then
            echo "âŒ ERROR: CED_USERNAME or CED_PASSWORD not set in GitHub Secrets!"
            echo "Go to: Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret"
            exit 1
          fi
          echo "âœ… Credentials found"
      
      - name: ğŸ•·ï¸ Run CED Lab Pro Scraper
        env:
          CED_USERNAME: ${{ secrets.CED_USERNAME }}
          CED_PASSWORD: ${{ secrets.CED_PASSWORD }}
        run: python cedlab_scraper.py
      
      - name: ğŸ“Š Show results summary
        run: |
          if [ -f data/certificates-data.json ]; then
            echo "ğŸ“Š Certificates scraped:"
            python -c "import json; d=json.load(open('data/certificates-data.json')); print(f'Total: {d[\"metadata\"][\"total\"]}')"
            echo ""
            echo "ğŸ“ File size:"
            ls -lh data/certificates-data.json
          else
            echo "âš ï¸ No output file generated"
          fi
      
      - name: ğŸ’¾ Commit and push data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add data/certificates-data.json
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ No changes to commit"
          else
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M')
            COUNT=$(python -c "import json; d=json.load(open('data/certificates-data.json')); print(d['metadata']['total'])" 2>/dev/null || echo "?")
            git commit -m "ğŸ”„ CED Lab Pro update: ${COUNT} certificates [${TIMESTAMP}]"
            git push
            echo "âœ… Changes pushed successfully"
          fi
      
      - name: ğŸ“¤ Upload data artifact
        uses: actions/upload-artifact@v4
        with:
          name: certificates-data-${{ github.run_number }}
          path: data/certificates-data.json
          retention-days: 7
      
      - name: ğŸ“¸ Upload debug screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: debug-screenshots-${{ github.run_number }}
          path: |
            *.png
            login_page.png
            search_page_before.png
            search_page_after.png
          retention-days: 3
          if-no-files-found: ignore

  # Notify on failure
  notify-failure:
    runs-on: ubuntu-latest
    needs: scrape-certificates
    if: failure()
    
    steps:
      - name: âŒ Log failure
        run: |
          echo "âŒ CED Lab Pro scraper failed!"
          echo "Check the logs above for details."
          echo "Common issues:"
          echo "  - Login credentials changed"
          echo "  - Website structure changed"
          echo "  - Network timeout"
